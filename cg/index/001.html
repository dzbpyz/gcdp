<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <style type="text/css">


    .asLabel .mini-textbox-border,

    .asLabel .mini-textbox-input
      {
      	 /*  width:255px; */
        border:0;background:none;cursor:default; font-size: 14px;text-align:left;  width:200px;background:transparent
     }
    .asLabel .mini-buttonedit-border,
    .asLabel .mini-buttonedit-input,
    .asLabel .mini-textboxlist-border
    {
        border:0;background:none;cursor:default;
    }
    .asLabel .mini-buttonedit-button,
    .asLabel .mini-textboxlist-close
    {
        display:none;
    }
    .asLabel .mini-textboxlist-item
    {
    }
    td
    {
    	font-family: 宋体;
    	text-align: center;
    }
    </style>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <!-- 确保 boot.js 路径正确 -->
    <script src="../static/js/boot.js" type="text/javascript"></script>
    <!-- 确保 base.css 路径正确 -->
    <link href="../static/css/base.css" type="text/css" rel="stylesheet">
</head>
<body>

		<div size="100%" showcollapsebutton="true"  style="border:10px solid #000">

				   <form id="searchkey" method="post">
				   		<table  border="0" cellpadding="0" cellspacing="0">
				   	    <tr>
				   	    	 <td>

							 <img align="absmiddle" src="../static/picture/logo.png" style="text-align:left;"  />

							 </td>

							 <td colspan="4" style="text-align: center; ">


							<font style="font-size:30px;vertical-align:middle;font-weight :bold;"   >河钢股份有限公司承钢分公司</font>
							</td>

				   	    </tr>

				   	    </table>

						<table class="mtable" border="0" cellpadding="1" cellspacing="2" >


							<tr>
							<td colspan="4" style="font-weight:bold;font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">产品基本信息</td>
							</tr>
							 <tr>
								<td style="text-align: center;font-size:20px;">
									产品名称：
									<!-- 产<span style="letter-spacing:14px;"> </span>品<span style="letter-spacing:14px;"> </span>名<span style="letter-spacing:14px;"> </span>称： -->
								</td>

								<td colspan="3" >
									<input id="ITEM_NAME" name="ITEM_NAME"  class="mini-textbox asLabel" readOnly="true" style="text-align: center;"  value="螺纹钢" />
								</td>
							</tr>
							<tr>
								<td style="font-size:20px;">
									批次编号：
								</td>
								<td colspan="3" >
									<input id="LOT_NUMBER" name="LOT_NUMBER"  style="text-align: center;width: 100% " class="mini-textbox asLabel" readOnly="true"  style="text-align: center; " value="151010"/>
								</td>
							</tr>

							<tr>
								<td style="text-align: center;font-size:20px;">
									捆  号：
								</td>
								<td style="text-align: center">
                                    <!-- 注意：这里的 value 初始值会被下面的 JS 覆盖（如果 URL 参数存在） -->
									<input id="BINGDING_NUMBER" name="BINGDING_NUMBER" class="mini-textbox asLabel" readOnly="true"  style="text-align: center;" value=" "/>
								</td>
								<td style="text-align: center;font-size:20px;">
									材  质：
								</td>
								<td style="text-align: center">
									<input id="MATER_CATE" name="MATER_CATE"  class="mini-textbox asLabel" readOnly="true"  style="text-align: center;" value="螺纹钢"/>
								</td>
							</tr>
							<tr>
								<td style="text-align: center;font-size:20px;">
									规  格：
								</td>
								<td style="text-align: center">
									<input id="SEPEC" name="SEPEC" class="mini-textbox asLabel" readOnly="true"  style="text-align: center; " value="螺纹钢"/>
								</td>
								<td style="text-align: center;font-size:20px;">
									支  数：
								</td>
								<td style="text-align: center">
									<input id="ELE_NUMBER" name="ELE_NUMBER"  class="mini-textbox asLabel" readOnly="true"  style="text-align: center;" value="螺纹钢"/>
								</td>
							</tr>

							<tr>
								<td style="text-align: center;font-size:20px;">
									长  度(m)：
								</td>
								<td style="text-align: center">
									<input id="LENGTHE" name="LENGTHE" class="mini-textbox asLabel" readOnly="true"  style="text-align: center;" value="螺纹钢"/>
								</td>
								<td style="text-align: center;font-size:20px;">
									理  重(kg)：
								</td>
								<td style="text-align: center">
									<input id="THEORE_WEIGHT" name="THEORE_WEIGHT"  class="mini-textbox asLabel" readOnly="true" value="2515" style="text-align: center;"/>
								</td>
							</tr>
							<tr>
								<td style="text-align: center;font-size:20px;">
									实  重(kg)：
								</td>
								<td style="text-align: center">
									<input id="ACTUA_WEIGHT" name="ACTUA_WEIGHT" class="mini-textbox asLabel" readOnly="true"  style="text-align: center;" value="螺纹钢"/>
								</td>
								<td style="text-align: center;font-size:20px;">
									产出日期：
								</td>
								<td style="text-align: center">
									<input id="BIRTH_DATE" name="BIRTH_DATE" class="mini-textbox asLabel" readOnly="true"  style="text-align: center;" value="螺纹钢"/>
								</td>
							</tr>


							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">产品质量证明书查验及在线打印</td>
							</tr>
							<tr>
							<td colspan="1" style="text-align: right;font-size:20px;">
								质量证明书编号：
							</td>
							<td style="text-align: left"  colspan="2">
								<input id="ZLZMSBH" name="ZLZMSBH" class="mini-textbox" style="width: 100%" required="true" />
							</td>
							<td rowspan="2" style="text-align: left;">
							<!-- <input type="button" value="查 询" onclick="addPlan()"  style="width: 120px;height:100%;background: #2e9be2;color:#fff;font-size: 20px;font-family: 宋体;border:#ccc" /> -->
							<img src="../static/picture/chaxun.jpg" onclick="addPlan()" />
							</td>
							</tr>
							<tr>
								<td  colspan="1" style="text-align: right;font-size:20px;"  >
								发货日期：
							</td>
							<td style="text-align: left"  colspan="2">
								<input id="FHDATE" name="FHDATE" class="mini-datepicker" vtype="date:yyyy-MM-dd" required="true"  format="yyyy-MM-dd " showOkButton="true" showClearButton="false" style="width: 100%" />
							</td>
							</tr>
							<tr>

								<td colspan="2" style="font-size:15px;color:red;border-right:none"></td>
								<td colspan="2" style="font-size:15px;color:red;border-left:none">※请输入所持证明书信息查验</td>
							</tr>
							<tr>
								<td  colspan="1" style="text-align: right;font-size:20px;height:40px;border-bottom:none;border-right:none">
									质量证明书打印：
								</td>
								<td colspan="3" style="text-align: center;border-bottom:none;border-left:none"><input type="button" value="在线打印入口" onclick="online_print()"  style="width: 320px;height:100%;background: #2e9be2;color:#fff;font-size: 20px;font-family: 宋体;border:#ccc" />   请联系客服经理获取打印权限</td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:12px;height:40px;text-align: center;border-top:none">电脑端网址：<a  id = "online_print_link" href="http://cgcgw.cdvt.com.cn:89/cgcg/checkLogin.do" target="_blank">http://cgcgw.cdvt.com.cn:89/cgcg/checkLogin.do</a></td>
                                <!-- Changed id to avoid conflict with function name -->
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">产品问题反馈</td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:16px;height:40px;text-align: center;border-bottom:none">欢迎使用河钢客户服务中心信息反馈系统  
								<!-- <input type="button" value="点击跳转" onclick="online_fankui()"  style="width: 150px;height:95%;background: #2e9be2;color:#fff;font-size: 20px;font-family: 宋体;border:#ccc" /> -->
								<img src="../static/picture/fankui.jpg" onclick="online_fankui()">
								</td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:12px;height:40px;text-align: center;border-top:none">电脑端网址：<a id="online_fankui_link" href="http://sale.hbistc.com/saleweb/crmWeChat/feedBack.htm" target="_blank">http://sale.hbistc.com/saleweb/crmWeChat/feedBack.htm</a></td>
                                <!-- Changed id to avoid conflict with function name -->
							</tr>

							<tr>
								<td colspan="2" style="text-align: center;border-bottom:none;border-left:none;"><input type="button" value="化学成分" onclick="showDialoghuaxue()"  style="width: 450px;height:40px;background: #0000FF;color:#fff;font-size: 10px;font-size:26px;font-family: 宋体;border:#ccc" /></td>
								<td colspan="2" style="text-align: center;border-bottom:none;border-left:none;"><input type="button" value="物理性能" onclick="showDialogwuli()"  style="width: 450px;height:40px;background: #0000FF;color:#fff;font-size: 10px;font-size:26px;font-family: 宋体;border:#ccc" /></td>
							</tr>


							<!-- Removed closing </tr> tag here as it was misplaced -->


							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">企业简介——河钢承钢</td>
							</tr>

							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-bottom:none;border-top:none" > 河钢集团有限公司（简称“河钢集团”、“河钢”）于2008年6月30日组建成立，拥有直属子分公司20余家，目前已经发展成为以钢铁为主业，矿山资源、金融服务、装备制造、现代物流等相关产业协同发展的产业格局。2019年居世界500强第214位。目前，集团具备5000万吨世界先进装备水平、国内领先节能环保水平的钢铁产能。
                            	</td>
                            </tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-bottom:none;border-top:none" > 河钢集团承钢公司（简称“河钢承钢”）1954年建厂，是国家“一五”期间苏联援建的156个项目之一，是世界500强企业河钢集团的一级骨干子公司。河钢承钢是依托承德地区丰富的钒钛磁铁矿资源、依靠自主创新建设发展起来的大型钒钛钢铁材料企业，是中国钒钛磁铁矿高炉冶炼和钒提取加工技术的发祥地，钒钛资源综合开发利用产业化技术处于世界领先水平,被誉为中国北方钒都。
                         	 	</td>
                            </tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-bottom:none;border-top:none" > 自二十世纪九十年代以来，河钢承钢不断加强了管理，严格按照管理体系标准，建立了质量、测量、能源、环境、职业健康安全、两化融合、知识产权管理体系，并以此持续改进管理。
								</td>
							</tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-top:none" > 河钢承钢含钒合金钢铁产品包括含钒棒、线、板、带四大系列，具有强度高、韧性好、耐腐蚀、易焊接、深冲性优等优良特性，多个产品被评为全国冶金产品实物质量金杯奖、冶金行业品质卓越产品、河北省名牌产品。河钢承钢是“燕山牌”螺纹钢产品的源产地，其生产的Φ6～Φ50mm全规格、全等级含钒高强螺纹钢筋产品全部荣获全国冶金产品实物质量“金杯奖”，产品广泛应用于国内外标志性建筑、超高层建筑、核电、大跨度桥梁、高铁等工程项目。</td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;border-bottom:none ">企业荣誉</td>
							</tr>
							<tr>
							<td colspan="4" style="text-indent: 2em;border-top:none" >
							<img src="../static/picture/qyry.png" /></td>
							</tr>
							<tr>
							<td colspan="4" style="font-weight:bold;font-size:26px;border-bottom:none">产品范围</td>
							</tr>
							<tr>
							<td colspan="4" style="text-indent: 2em;border-top:none" >
							<img src="../static/picture/cpfw.png" /></td>
							</tr>
							<tr>
							<td colspan="4" style="font-weight:bold;font-size:26px;border-bottom:none;">联系我们</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none" >
							<img align="absmiddle" src="../static/picture/hbis.png"  />
							</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none" >
							地址：河北省承德市双滦区滦河镇钢城路1号
							</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none" >
							网址：http：//www.cdsteel.cn
							</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none" >
							服务电话：+86-0314-4078888 客服专线：400-188-8286
							</td>
							</tr>


                            <tr>
							<td colspan="4" style="font-size:15px;" >
							<img src="../static/picture/hbisewm.png" /></td>
							</tr>
						</table>
						</form>

		</div>

<!-- 定义dialog模板 -->
<div id="huaxueDialog" class="mini-window" title="化学成分%" style="width:600px;height:300px;display:none;">
    <div style="padding:10px;">
        <table border="1" style="width:100%"> <!-- Added width:100% for better layout -->
            <tr>
               <th style="text-align: center;font-size:25px;">项目</th> <!-- Changed td to th for header -->
               <th style="text-align: center;font-size:25px;">结果</th> <!-- Changed td to th for header -->
            </tr>
            <tr>
                 <td style="text-align: center;font-size:20px;">C</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="c" name="C"   style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">Mn</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="mn" name="MN"  style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">Si</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="si" name="SI"   style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">P</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="p" name="P"  style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">S</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="s" name="S"  style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">Ceq(CEV)</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="ceq" name="CEQ"  style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
        </table>
    </div>
</div>

<div id="wuliDialog" class="mini-window" title="物理性能" style="width:600px;height:300px;display:none;"> <!-- Removed % from title -->
    <div style="padding:10px;">
        <table border="1" style="width:100%"> <!-- Added width:100% for better layout -->
            <tr>
               <th style="text-align: center;font-size:25px;">项目</th> <!-- Changed td to th for header -->
               <th style="text-align: center;font-size:25px;">结果</th> <!-- Added missing header -->
            </tr>
            <tr>
                 <td style="text-align: center;font-size:20px;">rm/MPA</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="tensilestrength" name="TENSILESTRENGTH"  style="text-align: center;"  class="mini-textbox asLabel" readOnly="true"   />
                </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">ReL(RP0.2)/Mp</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="yieldstrength" name="YIELDSTRENGTH" style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">Agt% </td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="agtstrength" name="AGTSTRENGTH"  style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">ROm/ROeL</td> <!-- Label seems technical, kept as is -->
                 <td style="text-align: center;font-size:20px;" >
                     <input id="coldbend" name="COLDBEND" style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">ROeL/ReL</td> <!-- Label seems technical, kept as is -->
                 <td style="text-align: center;font-size:20px;" >
                     <input id="inflection" name="INFLECTION" style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:20px;">冷弯结果</td>
                 <td style="text-align: center;font-size:20px;" >
                     <input id="coldbendresult" name="COLDBENDRESULT" style="text-align: center;" class="mini-textbox asLabel" readOnly="true"   />
                 </td>
            </tr>
        </table>
    </div>
</div>


<script type="text/javascript">
    mini.parse(); // Initialize MiniUI components

    // --- NEW CODE START: Function to get URL parameters ---
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        // Use decodeURIComponent to handle encoded characters like %20 for space
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    // --- NEW CODE END ---

    // --- Call the search function to load initial data ---
    search();

    // --- NEW CODE START: Get 'kh' parameter and update the input ---
    // This runs *after* search() is called, potentially overriding the value from AJAX if needed
    // Or move this logic inside the success callback of search() if you want it strictly after AJAX loads
    var khValue = getUrlParameter('kh');
    if (khValue) { // Check if khValue is not empty
        var bingdingNumberInput = mini.get("BINGDING_NUMBER");
        if (bingdingNumberInput) {
            bingdingNumberInput.setValue(khValue);
            console.log("Set BINGDING_NUMBER from URL parameter 'kh':", khValue); // Optional log
        }
    }
    // --- NEW CODE END ---


    // --- Existing Functions ---

     function showDialogwuli() {
       var key = GetDatakey();
       $.ajax({
                 url: "/erwm_new/lx/jiekou.do",
                 type: 'post',
                    data: { key: key, actiondes :'wuli'},
                    cache: false,
                    dataType: 'text', // Explicitly expect text
                    success: function (text) {
                        try {
                            // Attempt to remove potential surrounding quotes or brackets if present
                            var cleanedText = text;
                            if (cleanedText.startsWith('"') && cleanedText.endsWith('"')) {
                                cleanedText = cleanedText.substring(1, cleanedText.length - 1);
                            }
                            if (cleanedText.startsWith('[') && cleanedText.endsWith(']')) {
                                cleanedText = cleanedText.substring(1, cleanedText.length - 1);
                            }
                            // Replace escaped quotes if necessary (adjust based on actual server response)
                            cleanedText = cleanedText.replace(/\\"/g, '"');

                            // Use JSON.parse for safety instead of eval
                            var m = JSON.parse(cleanedText);

                            mini.get("tensilestrength").setValue(m.TENSILESTRENGTH || ''); // Use || '' as fallback
                            mini.get("yieldstrength").setValue(m.YIELDSTRENGTH || '');
                            mini.get("agtstrength").setValue(m.AGTSTRENGTH || '');
                            mini.get("coldbend").setValue(m.COLDBEND || '');
                            mini.get("inflection").setValue(m.INFLECTION || '');
                            mini.get("coldbendresult").setValue(m.COLDBENDRESULT || '');

                            var dialog = mini.get("wuliDialog");
                            if (dialog) {
                                dialog.show();
                            }
                         } catch (e) {
                             console.error("Error parsing wuli data:", e);
                             console.error("Original response text:", text);
                             alert("获取物理性能数据失败或数据格式错误。");
                         }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("AJAX Error (wuli):", textStatus, errorThrown, jqXHR.responseText);
                        alert("请求物理性能数据失败: " + textStatus);
                    }
                });
    }

    function showDialoghuaxue() {
       var key = GetDatakey();
       $.ajax({
                 url: "/erwm_new/lx/jiekou.do",
                 type: 'post',
                    data: { key: key, actiondes :'huaxue'},
                    cache: false,
                    dataType: 'text', // Explicitly expect text
                    success: function (text) {
                       try {
                            // Attempt to clean and parse JSON safely
                            var cleanedText = text;
                             if (cleanedText.startsWith('"') && cleanedText.endsWith('"')) {
                                cleanedText = cleanedText.substring(1, cleanedText.length - 1);
                            }
                            if (cleanedText.startsWith('[') && cleanedText.endsWith(']')) {
                                cleanedText = cleanedText.substring(1, cleanedText.length - 1);
                            }
                            cleanedText = cleanedText.replace(/\\"/g, '"');

                            var m = JSON.parse(cleanedText);

                            mini.get("c").setValue(m.C || '');
                            mini.get("mn").setValue(m.MN || '');
                            mini.get("si").setValue(m.SI || '');
                            mini.get("p").setValue(m.P || '');
                            mini.get("s").setValue(m.S || '');
                            mini.get("ceq").setValue(m.CEQ || '');

                            var dialog = mini.get("huaxueDialog");
                            if (dialog) {
                                dialog.show();
                            }
                        } catch (e) {
                             console.error("Error parsing huaxue data:", e);
                             console.error("Original response text:", text);
                             alert("获取化学成分数据失败或数据格式错误。");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("AJAX Error (huaxue):", textStatus, errorThrown, jqXHR.responseText);
                        alert("请求化学成分数据失败: " + textStatus);
                    }
                });
    }

    function online_print(){
        // Use the modified ID for the link
        var link = document.getElementById("online_print_link");
        if(link) {
            link.click();
        } else {
            console.error("Online print link not found");
        }
    }

    function online_fankui(){
        // Use the modified ID for the link
        var link = document.getElementById("online_fankui_link");
         if(link) {
            link.click();
        } else {
            console.error("Online fankui link not found");
        }
    }

    function search() {
      var key = GetDatakey();
       $.ajax({
                 url: "/erwm_new/lx/jiekou.do",
                 type: 'post',
                 data: { key: key, actiondes :'getybgl'},
                 cache: false,
                 dataType: 'text', // Expect text, parse manually for safety
                 success: function (text) {
                    try {
                        // Attempt to clean and parse JSON safely
                        var cleanedText = text;
                        if (cleanedText.startsWith('"') && cleanedText.endsWith('"')) {
                            cleanedText = cleanedText.substring(1, cleanedText.length - 1);
                        }
                         if (cleanedText.startsWith('[') && cleanedText.endsWith(']')) {
                            cleanedText = cleanedText.substring(1, cleanedText.length - 1);
                        }
                        cleanedText = cleanedText.replace(/\\"/g, '"');

                        var m = JSON.parse(cleanedText);

                        mini.get("ITEM_NAME").setValue(m.ITEM_NAME || '');
                        // Don't set BINGDING_NUMBER here if URL param should always win
                        // Or set it, and let the code outside this function override it if kh param exists
                        mini.get("BINGDING_NUMBER").setValue(m.BINGDING_NUMBER || ''); // Set default from AJAX
                        mini.get("MATER_CATE").setValue(m.MATER_CATE || '');
                        mini.get("SEPEC").setValue(m.SEPEC || '');
                        mini.get("LENGTHE").setValue(m.LENGTHE || '');
                        mini.get("ELE_NUMBER").setValue(m.ELE_NUMBER || '');
                        mini.get("THEORE_WEIGHT").setValue(m.THEORE_WEIGHT || '');
                        mini.get("ACTUA_WEIGHT").setValue(m.ACTUA_WEIGHT || '');
                        mini.get("BIRTH_DATE").setValue(m.BIRTH_DATE || '');

                        // --- OPTIONAL: If URL param should ONLY override after AJAX success, move the check here ---
                        /*
                        var khValue = getUrlParameter('kh');
                        if (khValue) {
                            var bingdingNumberInput = mini.get("BINGDING_NUMBER");
                            if (bingdingNumberInput) {
                                bingdingNumberInput.setValue(khValue);
                                console.log("Set BINGDING_NUMBER from URL parameter 'kh' after AJAX:", khValue);
                            }
                        }
                        */
                        // --- END OPTIONAL MOVE ---

                    } catch (e) {
                        console.error("Error parsing getybgl data:", e);
                        console.error("Original response text:", text);
                        alert("获取产品基本信息失败或数据格式错误。");
                    }
                 },
                 error: function (jqXHR, textStatus, errorThrown) {
                     console.error("AJAX Error (getybgl):", textStatus, errorThrown, jqXHR.responseText);
                     alert("请求产品基本信息失败: " + textStatus);
                 }
             });
    }

    function GetDatakey() {
       var searchkey = new mini.Form("#searchkey"); // Pass selector to Form constructor
       var o = searchkey.getData(true); // Pass true to format data
       // The endpoint might expect a specific structure, just sending 'key' might be enough
       // var json = mini.encode([o]); // This wraps it in an array, might not be needed
       // Assuming the server expects the 'key' param as built in the original AJAX calls.
       // Let's create a simple key if that's what the server expects based on other calls.
       // If the server truly expects a complex JSON string for 'key', adjust this.
       // For now, returning null as the AJAX calls construct the data object directly.
       // Update: The original AJAX calls create the 'key' data from the form.
       // GetDatakey seems intended to serialize the *whole* form, let's keep it, but ensure form ID is correct.
       var json = mini.encode(o); // Encode the object directly
       return json; // This might need adjustment based on what /erwm_new/lx/jiekou.do expects for the 'key' parameter
                     // Often, only specific fields are needed, not the whole form.
                     // The existing code seems to use this function only to build the data object inside ajax calls,
                     // so perhaps this function isn't strictly necessary as implemented. Let's refine the AJAX calls instead.

                     // Let's revert GetDatakey to its original simple form if it's just a placeholder
                     // or if the key data is built directly in the $.ajax call.
                     // Given the usage, it seems like it might be intended to return a specific identifier,
                     // but the implementation tries to serialize the form. Let's assume the $.ajax
                     // data construction `data: { key: key, actiondes :'...'} ` is correct and `key`
                     // variable is populated correctly elsewhere (though it's not shown how).
                     // If 'key' should come from a specific input, we need that logic.
                     // Let's assume 'key' is globally available or derived differently for now.
                     // Returning an empty object as a placeholder. Modify if needed.
       return {}; // Placeholder, adjust if GetDatakey has a real purpose
    }


    function addPlan() {
        var zlzmsbhInput = mini.get("ZLZMSBH");
        var fhdateInput = mini.get("FHDATE");
        var lotNumberInput = mini.get("LOT_NUMBER"); // Get lot number field

        if (!zlzmsbhInput || !fhdateInput || !lotNumberInput) {
            mini.alert("页面组件加载不完整，请刷新重试。");
            return;
        }

        var zlzmsbhValue = zlzmsbhInput.getValue();
        var fhdateValue = fhdateInput.getFormValue(); // Use getFormValue for date format yyyy-MM-dd
        var lotNumberValue = lotNumberInput.getValue(); // Get the value of LOT_NUMBER


        if (zlzmsbhValue == "") {
         	mini.alert("请填写质量证明书编号");
         	return;
       	}

       	// Check if date is selected and valid
       	if (fhdateValue == "" || fhdateValue == null || fhdateValue == "null") { // Added null check
         	mini.alert("请填写有效的发货日期");
         	return;
       	}

        // Check if lot number is available (it's readOnly, but check anyway)
        if (lotNumberValue == "") {
            mini.alert("批次编号缺失，无法查询。");
            return;
        }


       	// Navigate to the results page
        // Ensure the base path is correct for your deployment
        window.location.href ='/erwm_new/jsp/zmscx.jsp?ZLZMSBH=' + encodeURIComponent(zlzmsbhValue)
                                + '&LOT_NUMBER=' + encodeURIComponent(lotNumberValue)
                                + '&FHDATE=' + encodeURIComponent(fhdateValue);

    }
</script>

</body>
</html>