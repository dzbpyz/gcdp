<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="../static/js/boot.js" type="text/javascript"></script>
    <link href="../static/css/base.css" type="text/css" rel="stylesheet">
    <!-- 新增的 CSS 样式 -->
    <style type="text/css">
        /* 为ID为FHDATE的输入框设置placeholder样式 */
        #FHDATE::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
            color: #cccccc; /* 浅灰色 */
            opacity: 1; /* Firefox 需要这个来确保颜色被应用 */
        }

        #FHDATE:-ms-input-placeholder { /* Internet Explorer 10-11 */
            color: #cccccc;
        }

        #FHDATE::-ms-input-placeholder { /* Microsoft Edge */
            color: #cccccc;
        }

        /* 自定义模态对话框样式 */
        #custom-modal-overlay {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定定位，覆盖整个视口 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* 半透明黑色背景 */
            z-index: 1000; /* 确保在其他内容之上 */
        }

        #custom-modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* 精确居中 */
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001; /* 在遮罩层之上 */
            min-width: 300px; /* 最小宽度 */
            max-width: 90%;   /* 最大宽度，对于小屏幕友好 */
            border: 1px solid #ccc;
            text-align: left; /* 内部文本默认左对齐 */
        }

        #custom-modal-message {
            margin-bottom: 20px;
            font-size: 16px; /* 适中的字体大小 */
            line-height: 1.5; /* 改善可读性的行高 */
            color: #333333;   /* 深灰色文本 */
            font-family: 宋体, Arial, sans-serif; /* 与页面风格统一 */
        }

        #custom-modal-close {
            display: block; /* 使按钮成为块级元素，方便居中 */
            margin: 0 auto; /* 水平居中按钮 */
            padding: 10px 25px;
            background-color: #2e9be2; /* 使用页面已有的主题蓝色 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-family: 宋体, Arial, sans-serif;
        }

        #custom-modal-close:hover {
            background-color: #257cb6; /* 鼠标悬停时颜色变深 */
        }
        /* 自定义模态对话框样式结束 */
    </style>
</head>
<body>

		<div size="100%" showcollapsebutton="true"  style="border:10px solid #000">

				   <form id="searchkey" method="post">
				   		<table  border="0" cellpadding="0" cellspacing="0">
				   	    <tr>
				   	    	 <td>
							 <img align="absmiddle" src="../static/picture/logo.png" style="text-align:left;"  />
							 </td>
							 <td colspan="4" style="text-align: center; ">
							<font style="font-size:30px;vertical-align:middle;font-weight :bold;font-family: 宋体;"   >河钢股份有限公司承钢分公司</font>
							</td>
				   	    </tr>
				   	    </table>
						<table class="mtable" border="0" cellpadding="1" cellspacing="2" >
							<tr>
							<td colspan="4" style="font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">产品基本信息</td>
							</tr>
							 <tr>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									产品名称：
								</td>
								<!-- 示例：如果需要动态更新，可以给td或内部span加id，如 <td id="productNameCell">螺纹钢 </td> -->
								<td colspan="3" >螺纹钢 </td>
							</tr>
							<tr>
								<td style="font-size:20px;font-family: 宋体;">
									批次编号：
								</td>
								<td style="text-align: left"  colspan="3">25Y202188G20250219062635 </td>
							</tr>
	                        <tr>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									捆  号：
							  </td>
								<td id="khValueCell" style="text-align: center">   B-<span id="khDynamicSuffix">01 </span> </td>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									材  质：
							  </td>
								<td style="text-align: center">HRB400E </td>
							</tr>
							<tr>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									规  格：
							  </td>
								<td style="text-align: center">   Φ14 </td>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									支  数：
							  </td>
								<td style="text-align: center">220 </td>
							</tr>
							<tr>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									长  度(m)：
							  </td>
								<td style="text-align: center"> 12</td>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									理  重(kg)：
							  </td>
								<td style="text-align: center">3194 </td>
							</tr>
							<tr>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									实  重(kg)：
								</td>
								 <td style="text-align: center; min-width: 200px;">
                                 <span id="szDynamicValue"> </span> <!-- 用于JS动态填充实重 -->
                                 </td>
								<td style="text-align: center;font-size:20px;font-family: 宋体;">
									产出日期：
								</td>
								<td style="text-align: center; min-width: 200px;">
								   2025-02-19
								</td>
							</tr>
							<tr>
								<td colspan="4" style=";font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">产品质量证明书查验及在线打印</td>
							</tr>
							<tr>
							<td colspan="1" style="text-align: right;font-size:20px;">
								质量证明书编号：
							</td>
							<td style="text-align: left" colspan="2">
								<!-- 应用 MiniUI 样式 -->
								<input id="ZLZMSBH" name="ZLZMSBH" class="mini-textbox" style="width: 100%" required="true" />
							</td>
							<td rowspan="2" style="text-align: left;">
							<!-- 移除了原先的 button，直接使用 img 触发 addPlan -->
							<img src="../static/picture/chaxun.jpg" onclick="addPlan()" alt="查询" style="cursor:pointer; vertical-align: middle;"> <!-- 增加了 vertical-align 和 cursor -->
							</td>
							</tr>
							<tr>
								<td colspan="1" style="text-align: right;font-size:20px;">
								发货日期：
							</td>
							<td style="text-align: left" colspan="2">
								<!-- 应用 MiniUI 样式 -->
								<input id="FHDATE" name="FHDATE" class="mini-datepicker" placeholder="YYYY-MM-DD" vtype="date:yyyy-MM-dd" required="true"  format="yyyy-MM-dd" showOkButton="true" showClearButton="false" style="width: 100%" />
							</td>
							</tr>
							<tr>
								<td colspan="2" style="font-size:15px;color:red;border-right:none"></td>
								<td colspan="2" style="font-size:15px;color:red;border-left:none">※请输入所持证明书信息查验</td>
							</tr>
							<tr>
								<td colspan="1" style="text-align: right;font-size:20px;height:40px;border-bottom:none;border-right:none">
									质量证明书打印：
								</td>
								<td colspan="3" style="text-align: center;border-bottom:none;border-left:none"><input type="button" value="在线打印入口" onclick="online_print()" style="width: 320px;height:100%;background: #2e9be2;color:#fff;font-size: 20px;font-family: 宋体;border:#ccc">   请联系客服经理获取打印权限</td>
							</tr>
							<tr>
                                <!-- 注意：原HTML中 online_print 函数是点击一个<a>标签，id为online_print。为保持一致，将id从td移到a标签上 -->
								<td colspan="4" style="font-weight:bold;font-size:12px;height:40px;text-align: center;border-top:none">电脑端网址：<a id="online_print_link" href="http://cgcgw.cdvt.com.cn:89/cgcg/checkLogin.do" target="_blank">http://cgcgw.cdvt.com.cn:89/cgcg/checkLogin.do</a></td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">产品问题反馈</td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:16px;height:40px;text-align: center;border-bottom:none">欢迎使用河钢客户服务中心信息反馈系统  
								<img src="../static/picture/fankui.jpg" onclick="online_fankui()" alt="反馈" style="cursor:pointer; vertical-align: middle;"> <!-- 增加了 vertical-align 和 cursor -->
								</td>
							</tr>
							<tr>
                                <!-- 注意：原HTML中 online_fankui 函数是点击一个<a>标签，id为online_fankui。为保持一致，将id从td移到a标签上 -->
								<td colspan="4" style="font-weight:bold;font-size:12px;height:40px;text-align: center;border-top:none">电脑端网址：<a id="online_fankui_link" href="http://sale.hbistc.com/saleweb/crmWeChat/feedBack.htm" target="_blank">http://sale.hbistc.com/saleweb/crmWeChat/feedBack.htm</a></td>
							</tr>
                            <!-- 表格行到此结束 -->
	                            <!-- “化学成分”和“物理性能”按钮 -->
							<tr>
								<td colspan="2" style="text-align: center;border-bottom:none;border-left:none;"><input type="button" value="化学成分" onclick="showDialoghuaxue()" style="width: 90%; max-width: 450px; height:40px;background: #0000FF;color:#fff;font-size:22px; font-family: 宋体;border:#ccc; margin: 5px;"></td> <!-- 调整了宽度和增加了边距 -->
								<td colspan="2" style="text-align: center;border-bottom:none;border-left:none;"><input type="button" value="物理性能" onclick="showDialogwuli()" style="width: 90%; max-width: 450px; height:40px;background: #0000FF;color:#fff;font-size:22px; font-family: 宋体;border:#ccc; margin: 5px;"></td> <!-- 调整了宽度和增加了边距, 统一了字体大小 -->
							</tr>

							<!-- 企业简介 -->
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;color: #fff;background-color: #2e9be2;height:40px;">企业简介——河钢承钢</td>
							</tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-bottom:none;border-top:none; padding: 5px 10px;"> 河钢集团有限公司（简称“河钢集团”、“河钢”）于2008年6月30日组建成立，拥有直属子分公司20余家，目前已经发展成为以钢铁为主业，矿山资源、金融服务、装备制造、现代物流等相关产业协同发展的产业格局。2019年居世界500强第214位。目前，集团具备5000万吨世界先进装备水平、国内领先节能环保水平的钢铁产能。
                            	</td>
                            </tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-bottom:none;border-top:none; padding: 5px 10px;"> 河钢集团承钢公司（简称“河钢承钢”）1954年建厂，是国家“一五”期间苏联援建的156个项目之一，是世界500强企业河钢集团的一级骨干子公司。河钢承钢是依托承德地区丰富的钒钛磁铁矿资源、依靠自主创新建设发展起来的大型钒钛钢铁材料企业，是中国钒钛磁铁矿高炉冶炼和钒提取加工技术的发祥地，钒钛资源综合开发利用产业化技术处于世界领先水平,被誉为中国北方钒都。
                         	 	</td>
                            </tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-bottom:none;border-top:none; padding: 5px 10px;"> 自二十世纪九十年代以来，河钢承钢不断加强了管理，严格按照管理体系标准，建立了质量、测量、能源、环境、职业健康安全、两化融合、知识产权管理体系，并以此持续改进管理。
								</td>
							</tr>
							<tr>
								<td colspan="4" style="text-indent: 2em;text-align: justify;border-top:none; padding: 5px 10px;"> 河钢承钢含钒合金钢铁产品包括含钒棒、线、板、带四大系列，具有强度高、韧性好、耐腐蚀、易焊接、深冲性优等优良特性，多个产品被评为全国冶金产品实物质量金杯奖、冶金行业品质卓越产品、河北省名牌产品。河钢承钢是“燕山牌”螺纹钢产品的源产地，其生产的Φ6～Φ50mm全规格、全等级含钒高强螺纹钢筋产品全部荣获全国冶金产品实物质量“金杯奖”，产品广泛应用于国内外标志性建筑、超高层建筑、核电、大跨度桥梁、高铁等工程项目。</td>
							</tr>
							<tr>
								<td colspan="4" style="font-weight:bold;font-size:26px;border-bottom:none; padding: 10px 0 5px 10px;">企业荣誉</td> <!-- 调整了内边距 -->
							</tr>
							<tr>
							<td colspan="4" style="text-indent: 2em;border-top:none; text-align:center;"> <!-- 图片居中显示 -->
							<img src="../static/picture/qyry.png" alt="企业荣誉" style="max-width:100%; height:auto;"> <!-- 图片自适应宽度 -->
                            </td>
							</tr>
							<tr>
							<td colspan="4" style="font-weight:bold;font-size:26px;border-bottom:none; padding: 10px 0 5px 10px;">产品范围</td> <!-- 调整了内边距 -->
							</tr>
							<tr>
							<td colspan="4" style="text-indent: 2em;border-top:none; text-align:center;"> <!-- 图片居中显示 -->
							<img src="../static/picture/cpfw.png" alt="产品范围" style="max-width:100%; height:auto;"> <!-- 图片自适应宽度 -->
                            </td>
							</tr>
							<tr>
							<td colspan="4" style="font-weight:bold;font-size:26px;border-bottom:none; padding: 10px 0 5px 10px;">联系我们</td> <!-- 调整了内边距 -->
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none; padding-left: 10px;">
							<img align="absmiddle" src="../static/picture/hbis.png" alt="HBIS Logo">
							</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none; padding-left: 10px;">
							地址：河北省承德市双滦区滦河镇钢城路1号
							</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none; padding-left: 10px;">
							网址：http：//www.cdsteel.cn
							</td>
							</tr>
							<tr>
							<td colspan="4" style="font-size:15px;border-bottom:none;border-top:none; padding-left: 10px;">
							服务电话：+86-0314-4078888 客服专线：400-188-8286
							</td>
							</tr>
                            <tr>
							<td colspan="4" style="font-size:15px; text-align:center; padding: 10px;"> <!-- 二维码居中显示 -->
							<img src="../static/picture/hbisewm.png" alt="河钢二维码" style="max-width:150px; height:auto;"> <!-- 限制了二维码图片的最大宽度 -->
                            </td>
							</tr>
						</table>
						</form>
		</div>

<!-- 定义dialog模板 -->
<div id="huaxueDialog" class="mini-window" title="化学成分%" style="width:90%; max-width:600px; height:auto; display:none;"> <!-- 宽度自适应，最大600px, 高度自动 -->
    <div style="padding:10px; overflow-x: auto;"> <!-- 增加溢出处理 -->
    <table border="1" style="width:100%; border-collapse: collapse;"> <!-- 表格宽度100%，边框合并 -->
        <thead>
            <tr>
               <th style="text-align: center;font-size:20px; padding: 8px;">项目</th> <!-- 调整了字体和内边距 -->
               <th style="text-align: center;font-size:20px; padding: 8px;">结果</th> <!-- 调整了字体和内边距 -->
            </tr>
        </thead>
        <tbody>
            <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">C</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="c" name="C" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:50px;"> <!-- 调整了宽度 -->
                </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">Mn</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="mn" name="MN" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:50px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">Si</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="si" name="SI" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:50px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">P</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="p" name="P" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:50px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">S</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="s" name="S" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:50px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">Ceq(CEV)</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="ceq" name="CEQ" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:50px;">
                 </td>
            </tr>
        </tbody>
    </table>
    </div>
</div>


<div id="wuliDialog" class="mini-window" title="物理性能" style="width:90%; max-width:600px; height:auto; display:none;"> <!-- 宽度自适应，最大600px, 高度自动, 标题移除了'%' -->
    <div style="padding:10px; overflow-x: auto;"> <!-- 增加溢出处理 -->
    <table border="1" style="width:100%; border-collapse: collapse;"> <!-- 表格宽度100%，边框合并 -->
        <thead>
            <tr>
               <th style="text-align: center;font-size:20px; padding: 8px;">项目</th> <!-- 调整了字体和内边距 -->
               <th style="text-align: center;font-size:20px; padding: 8px;">结果</th> <!-- 新增结果列标题 -->
            </tr>
        </thead>
        <tbody>
            <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">rm/MPA</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="tensilestrength" name="TENSILESTRENGTH" class="mini-textbox asLabel" readonly="true" style="text-align: center; width: 80%; min-width:80px;"> <!-- 调整了宽度 -->
                </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">ReL(RP0.2)/MPa</td> <!-- 修改 Mp 为 MPa -->
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="yieldstrength" name="YIELDSTRENGTH" class="mini-textbox asLabel" readonly="true" style="text-align: center; width: 80%; min-width:80px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">Agt%</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="agtstrength" name="AGTSTRENGTH" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:80px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">Rm/ReL</td> <!-- 原为 ROm/ROeL -->
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="coldbend" name="COLDBEND" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:80px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">ReH/ReL</td> <!-- 原为 ROeL/ReL, 假设是上屈服与下屈服比 -->
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="inflection" name="INFLECTION" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:80px;">
                 </td>
            </tr>
             <tr>
                 <td style="text-align: center;font-size:18px; padding: 8px;">冷弯结果</td>
                 <td style="text-align: center;font-size:18px; padding: 8px;">
                 <input id="coldbendresult" name="COLDBENDRESULT" class="mini-textbox asLabel" readonly="true" style="text-align: center;width: 80%; min-width:80px;">
                 </td>
            </tr>
        </tbody>
    </table>
    </div>
</div>
<!-- MiniUI 对话框 HTML 结束 -->
	<script type="text/javascript">
mini.parse(); // 初始化 MiniUI 控件
search();     // 页面加载时调用 search 函数加载初始数据 (如果需要的话)

// 显示“物理性能”对话框的函数
function showDialogwuli() {
    var key = GetDatakey(); // 获取表单数据
    if (!key) { // GetDatakey 可能会因为 mini.Form("searchkey") 未完全初始化而返回 null
        console.warn("showDialogwuli: GetDatakey 返回空值，可能 searchkey 表单未准备好。");
        // 可以选择延迟执行或提示用户
        // setTimeout(showDialogwuli, 200); // 简单延迟重试
        // return;
    }
    $.ajax({
        url: "/erwm_new/lx/jiekou.do", // 后端接口地址
        type: 'post',
        data: { key: key, actiondes: 'wuli' }, // 发送的数据
        cache: false,
        dataType: 'json', // 明确期望接收JSON数据
        success: function (m) { // 请求成功回调, m 已经是JSON对象
            if (m) {
                // 设置物理性能相关的输入框的值
                if(mini.get("tensilestrength")) mini.get("tensilestrength").setValue(m.TENSILESTRENGTH);
                if(mini.get("yieldstrength")) mini.get("yieldstrength").setValue(m.YIELDSTRENGTH);
                if(mini.get("agtstrength")) mini.get("agtstrength").setValue(m.AGTSTRENGTH);
                if(mini.get("coldbend")) mini.get("coldbend").setValue(m.COLDBEND); // 注意：此ID在HTML中对应Rm/ReL
                if(mini.get("inflection")) mini.get("inflection").setValue(m.INFLECTION); // 注意：此ID在HTML中对应ReH/ReL
                if(mini.get("coldbendresult")) mini.get("coldbendresult").setValue(m.COLDBENDRESULT);
            } else {
                console.error("物理性能数据解析失败或返回为空:", m);
                mini.alert("获取物理性能数据失败或数据格式错误。");
            }
        },
        error: function (jqXHR, textStatus, errorThrown) { // 请求失败回调
            console.error("获取物理性能数据失败:", textStatus, errorThrown, jqXHR.responseText);
            mini.alert("请求物理性能数据失败: " + textStatus);
        }
    });
    var dialog = mini.get("wuliDialog"); // 获取对话框对象
    if (dialog) {
        dialog.show(); // 显示对话框
    } else {
        console.error("wuliDialog 对象未找到!");
    }
}

// 显示“化学成分”对话框的函数
function showDialoghuaxue() {
    var key = GetDatakey();
    if (!key) {
        console.warn("showDialoghuaxue: GetDatakey 返回空值。");
        // setTimeout(showDialoghuaxue, 200);
        // return;
    }
    $.ajax({
        url: "/erwm_new/lx/jiekou.do",
        type: 'post',
        data: { key: key, actiondes: 'huaxue' },
        cache: false,
        dataType: 'json', // 明确期望接收JSON数据
        success: function (m) { // m 已经是JSON对象
             if (m) {
                // 设置化学成分相关的输入框的值
                if(mini.get("c")) mini.get("c").setValue(m.C);
                if(mini.get("mn")) mini.get("mn").setValue(m.MN);
                if(mini.get("si")) mini.get("si").setValue(m.SI);
                if(mini.get("p")) mini.get("p").setValue(m.P);
                if(mini.get("s")) mini.get("s").setValue(m.S);
                if(mini.get("ceq")) mini.get("ceq").setValue(m.CEQ);
            } else {
                console.error("化学成分数据解析失败或返回为空:", m);
                mini.alert("获取化学成分数据失败或数据格式错误。");
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.error("获取化学成分数据失败:", textStatus, errorThrown, jqXHR.responseText);
            mini.alert("请求化学成分数据失败: " + textStatus);
        }
    });
    var dialog = mini.get("huaxueDialog");
    if (dialog) {
        dialog.show();
    } else {
        console.error("huaxueDialog 对象未找到!");
    }
}

// “在线打印入口”按钮点击事件处理函数
function online_print() {
    // 在第一部分HTML中，我们将ID从td移到了a标签上，并命名为 "online_print_link"
    var printLink = document.getElementById("online_print_link");
    if (printLink) {
        printLink.click(); // 模拟点击链接
    } else {
        console.error("错误: 未找到 'online_print_link' 链接元素。");
        mini.alert("打印链接配置错误。");
    }
}

// “信息反馈系统”图片点击事件处理函数
function online_fankui() {
    // 在第一部分HTML中，我们将ID从td移到了a标签上，并命名为 "online_fankui_link"
    var fankuiLink = document.getElementById("online_fankui_link");
    if (fankuiLink) {
        fankuiLink.click(); // 模拟点击链接
    } else {
        console.error("错误: 未找到 'online_fankui_link' 链接元素。");
        mini.alert("反馈链接配置错误。");
    }
}

// search函数，用于获取并填充页面上的产品基本信息
function search() {
    var key = GetDatakey();
    if (!key) {
        console.warn("Search: GetDatakey 返回空值，可能 searchkey 表单未初始化。");
        // 可以考虑在 mini.parse() 完成后通过事件回调来调用 search，或者简单延迟
        // if (typeof mini !== 'undefined' && mini.isReady) { /* ... */ }
        // else { setTimeout(search, 200); return; }
    }
    $.ajax({
        url: "/erwm_new/lx/jiekou.do",
        type: 'post',
        data: { key: key, actiondes: 'getybgl' },
        cache: false,
        dataType: 'json', // 明确期望接收JSON数据
        success: function (m) { // m 已经是JSON对象
            if (m) {
                // 示例：如果想更新实重(kg)的<span>标签
                var szDynamicValueElement = document.getElementById("szDynamicValue");
                if (szDynamicValueElement && m.ACTUA_WEIGHT !== undefined) {
                     szDynamicValueElement.innerHTML = " " + m.ACTUA_WEIGHT + " ";
                }

                // 如果HTML中产品基本信息部分是MiniUI输入框，则可以像下面这样填充：
                // if (mini.get("ITEM_NAME") && m.ITEM_NAME !== undefined) mini.get("ITEM_NAME").setValue(m.ITEM_NAME);
                // if (mini.get("BINGDING_NUMBER") && m.BINGDING_NUMBER !== undefined) mini.get("BINGDING_NUMBER").setValue(m.BINGDING_NUMBER);
                // ...等等
                // 注意：当前HTML中，产品基本信息主要是静态文本，所以大部分mini.get().setValue()可能无效。
                // 您需要根据实际情况调整HTML或这里的JS来动态更新数据。
                 var khSuffixElement = document.getElementById("khDynamicSuffix");
                 if (khSuffixElement && m.BINGDING_NUMBER_SUFFIX !== undefined) { // 假设后端返回捆号后缀
                    khSuffixElement.innerText = m.BINGDING_NUMBER_SUFFIX + "\u00A0"; // \u00A0 是  
                 }


            } else {
                console.error("产品基本信息数据解析失败或返回为空:", m);
                // mini.alert("加载产品基本信息失败或数据格式错误。"); // 避免频繁弹窗
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.error("加载产品基本信息AJAX错误:", jqXHR.status, textStatus, errorThrown, jqXHR.responseText);
            // mini.alert("加载产品基本信息失败，请稍后重试。"); // 避免频繁弹窗
        }
    });
}

// 获取表单数据的辅助函数
function GetDatakey() {
    // 确保 mini.Form 已经准备好
    if (typeof mini === 'undefined' || !mini.get) {
        console.warn("GetDatakey: MiniUI尚未完全加载。");
        return null;
    }
    var searchkeyForm = mini.get("searchkey"); // 直接通过ID获取Form对象
    if (!searchkeyForm) {
        // 尝试通过 new mini.Form 来兼容旧用法，但更推荐直接用 ID 获取已存在的 Form
        try {
            searchkeyForm = new mini.Form("#searchkey"); // 使用CSS选择器
        } catch (e) {
             console.error("GetDatakey: 创建 mini.Form('searchkey') 失败: ", e);
             return null;
        }
    }
    if (!searchkeyForm) {
         console.error("GetDatakey: 无法获取ID为 'searchkey' 的 MiniUI 表单对象。");
         return null;
    }

    var o = searchkeyForm.getData(true); // true 表示获取格式化后的值
    var json = mini.encode(o); // 将数据编码为JSON字符串
    return json;
}


// --- 修改后的 addPlan 函数 ---
// 当点击查询图片 (chaxun.jpg) 时触发此函数
function addPlan() {
    var zlzmsbhInput = mini.get("ZLZMSBH"); // 获取“质量证明书编号”输入框的MiniUI对象
    var fhdateInput = mini.get("FHDATE");   // 获取“发货日期”输入框的MiniUI对象

    // 确保MiniUI控件已正确加载
    if (!zlzmsbhInput) {
        alert("错误：未找到“质量证明书编号”输入框组件。请检查HTML和MiniUI初始化。");
        console.error("错误: ZLZMSBH MiniUI 组件未找到。");
        return;
    }
    if (!fhdateInput) {
        alert("错误：未找到“发货日期”输入框组件。请检查HTML和MiniUI初始化。");
        console.error("错误: FHDATE MiniUI 组件未找到。");
        return;
    }

    var zlzmsbhValue = zlzmsbhInput.getValue();
    var fhdateValue = fhdateInput.getFormValue ? fhdateInput.getFormValue() : fhdateInput.getValue();

    if (zlzmsbhValue === "" || zlzmsbhValue === null) {
        mini.alert("请填写质量证明书编号");
        zlzmsbhInput.focus();
        return;
    }

    if (fhdateValue === "" || fhdateValue === null || fhdateValue === "null") {
        mini.alert("请填写发货日期");
        fhdateInput.focus();
        return;
    }

    if (zlzmsbhValue.includes('/') || zlzmsbhValue.includes('\\') || zlzmsbhValue.includes('..')) {
        mini.alert("质量证明书编号格式不正确，不能包含 / \\ .. 等特殊字符。");
        return;
    }

    // !!! 重要: 如果您的文件没有 .html 后缀 (例如文件名就是 '20250605')，
    // 请将下面这行修改为: var targetFileUrl = "../search/" + zlzmsbhValue;
    var targetFileUrl = "../search/" + zlzmsbhValue + ".html";

    fetch(targetFileUrl, { method: 'HEAD', cache: 'no-store' })
        .then(response => {
            if (response.ok) {
                window.location.href = targetFileUrl;
            } else {
                console.warn("文件 " + targetFileUrl + " 不存在或访问出错 (状态码: " + response.status + ")。即将刷新当前页面。");
                // mini.alert("未找到对应的质保书文件，页面将刷新。", function() { // 可选的用户提示
                //     window.location.reload();
                // });
                window.location.reload();
            }
        })
        .catch(error => {
            console.error("检查文件 '" + targetFileUrl + "' 时发生网络错误或异常: ", error);
            // mini.alert("检查文件时发生错误，页面将刷新。", function() { // 可选的用户提示
            //    window.location.reload();
            // });
            window.location.reload();
        });
}
// --- addPlan 函数结束 ---

</script>
</body>
</html>